<html>
    <body>
        <script src="https://cdn.rawgit.com/mozilla/localForage/master/dist/localforage.js"></script>
        <script src="index.js?v=1"></script>

<script>
//const bucket = KVdb.bucket('Q4bdSLuT8GVm4eH4hvHd98', 'secret');
KVdb.BASE_URL = 'http://localhost:1323'
const bucket = KVdb.bucket('EkBxK5753EgWuCM3jPgJ6A', 'secret');

KVdb.installLocalForageDriver(localforage)

localforage.config({
  bucket: bucket
})

localforage.setDriver([
  KVdb.LOCALFORAGE_DRIVER,
  //localforage.INDEXEDDB,
  //localforage.WEBSQL,
  //localforage.LOCALSTORAGE
  ]).then(async function() {
  var key = 'STORE_KEY';
  // var value = 'What we save offline';
  var value = 'asdf';
  value[0] = 65
  // var value = undefined;
  value = [1, 2, 3, 'four']
  var UNKNOWN_KEY = 'unknown_key';

  await localforage.setItem("foo", "bar")
  await localforage.setItem("bar", [1337])
  await localforage.setItem("qux", [1,2,3])

  localforage.setItem(key, value, function() {
    console.log('Using:' + localforage.driver());
    console.log('Saved: ' + value[3]);

    localforage.getItem(key).then(function(readValue) {
      console.log('Read: ', readValue);
      console.log('   --> type: ', readValue[3])
    });

    // Since this key hasn't been set yet, we'll get a null value
    localforage.getItem(UNKNOWN_KEY, function(err, readValue) {
      console.log('Result of reading ' + UNKNOWN_KEY, readValue);

      localforage.iterate(function(value, key, iterationNumber) {
        console.log(`<> #${iterationNumber} key=${key} value=${value}`)
      }).then(function() {
        console.log('iteration done!')
        //localforage.clear(function(err) {
        //  console.log('CLEARING.........', err)
        //})
      }).catch(function(err) {
        console.log('iteration error', err)
      })
    });
  });
});

// this is just for demonstration purposes
var originalConsoleLog = console.log;
function consoleLogProxy() {
  originalConsoleLog.apply(console, arguments);
  var htmlConsole = document.getElementById('htmlConsole');
  if (htmlConsole) {
    var message = Array.prototype.slice.apply(arguments, []).join(' ');
    htmlConsole.innerHTML += '<li>' + message + '</li>';
  }
}
//console.log = consoleLogProxy;






var storage;


async function myapp() {
  /*
  bucket.get('sampler')
        .then(res => console.log('GOT RESULT: ', res))
        .catch(err => console.log('cught: ', err))

  bucket.get('blah')
        .then(res => console.log('blah resul: ', res))
        .catch(err => console.log('bla cught: ', err))
  */

  /*
  let res = await bucket.get('sampler');
  console.log('res: ', res);

  try {
    res = await bucket.get('non-existent');
    console.log('non exist: ', res);
  } catch(e) {
    console.log('err: ', e)
  }
  */

  storage = bucket.localStorage()

  console.log('illegal index: ', await storage.key(-100))
  console.log('illegal key: ', await storage.getItem('sdklfjlksjdfs'))

  await storage.setItem('undefined', undefined)
  await storage.setItem('null', null)
  await storage.setItem('empty-string', "")

  console.log('undefined: ', await storage.getItem('undefined'))
  console.log('undefined: ', await storage.getItem('null'))
  console.log('undefined: ', await storage.getItem('empty-string'))

  console.log('list: ', await storage.length())

  await storage.setItem('0color', 'blue')

  var wait = [];
  for(var i = 0; i < 10; i++) {
    wait.push(storage.setItem('key-' + i, i))
  }
  await Promise.all(wait)

  console.log('blue == ', await storage.getItem('0color'))
  console.log('length: ', await storage.length())
  console.log('nth: 0 == ', await storage.key(0))

  const len = await storage.length()
  for(let i = 0; i < len; i++) {
    console.log(`${i}: `, await storage.key(i))
  }

  await storage.removeItem('0color')

  console.log('going to clear...')
  console.log('clearing... ', await storage.clear())
  console.log('done clearing!')
}

//myapp()
</script>
